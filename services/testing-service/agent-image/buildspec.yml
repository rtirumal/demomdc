version: 0.2

phases:
  pre_build:
    commands:
      - echo Entered the pre_build phase...
      - pip3 install awscli --upgrade --user
      - echo `aws --version`
      - echo Logging in to Amazon ECR...
      - $(aws ecr get-login --region ${aws_region} --no-include-email)
      - env_name=${env_name}
      - agent_ecr_repo=${aws_account_id}.dkr.ecr.${aws_region}.amazonaws.com/${ecr_repo_name}
      - aws ssm get-parameter --region ${aws_region} --name /${service_name}/${env_name}/codebuild/github/read_token --with-decryption > /tmp/parameter.json
      - GITHUB_TOKEN=`jq '.Parameter.Value' /tmp/parameter.json | sed 's/"//g'`
      - rm -f /tmp/parameter.json
      - git clone -b ${github_branch} https://$GITHUB_TOKEN:x-oauth-basic@github.com/${github_org}/${github_repo} agent-image
      - cd agent-image
      - image_tag=${php_version_full}-$(date +%y%m%d%H%M%S)

  build:
    commands:
      - echo Build started on `date`
      - echo Building the Agent Docker image...
      - cd agent-image
      - docker build --no-cache --pull --build-arg magento_php_version=${php_version_full} -t $agent_ecr_repo:latest .
      - docker tag $agent_ecr_repo:latest $agent_ecr_repo:$image_tag
      - echo $agent_ecr_repo:$agent_tag
      - echo Build completed for image on `date`
  post_build:
    commands:
      - echo Pushing the $agent_ecr_repo Docker images...
      - docker push $agent_ecr_repo:$image_tag
      - docker push $agent_ecr_repo:latest
